
# 001. Rearquitetura do IdentityServer4

## 1. Contexto

O IdentityServer4 trabalha com uma estrutura de componentes para implementação dos endpoints 
que geralmente seguem o padrão:

- EndpointHandler: responsável por receber a requisição e delegar o processamento. Ex.: `AuthorizeEndpoint`.
- RequestValidator: responsável por validar a requisição produzindo um objeto validado. Ex.: `IAuthorizeRequestValidator`.
- ValidatedRequest: objeto validado que será utilizado para processar a requisição. Ex.: `ValidatedAuthorizeRequest`.
- ResponseGenerator: responsável por gerar a resposta da requisição. Ex.: `IAuthorizeResponseGenerator`.
- Response: objeto que será utilizado para gerar a resposta da requisição. Ex.: `AuthorizeResponse`.

Além dessa estrutura de componentes, o IdentityServer4 utiliza vários serviços para processar
diversas tarefas como persistência de dados, geração de tokens, etc.

A estrutura acima torna o código muito procedural e sequencial, onde mudanças são difíceis de serem
feitas e testadas. Além disso, a complexidade do código é muito alta, tornando difícil a manutenção
e a adição de novas funcionalidades.

Outro ponto é como os EndpointHandler são registrados no IdentityServer4, onde a um mecanismo
de roteamento próprio, o qual pode ser substituído por novos recursos do AspNetCore, como MinimalAPI.

## 2. Decisão

Para o RoyalIdentity planeja-se a reestruturação do IdentityServer4 para que o código seja mais modular,
com componentes mais especializados e com responsabilidades bem definidas.

Para isso será introduzido um mecanismo de pipeline para processamento das requisições,
onde haverá vários handlers que serão executados em sequência e cada um tratará de uma parte
do processamento da requisição.

Também será utilizado o MinimalAPI para registrar os handlers, aproveitando o recurso de roteamento
já existente no AspNetCore e facilitando a adição de novos handlers de endpoints.

Os handlers de endpoints terão uma nova responsabilidade, eles receberão o request, podem fazer validações
simples, e terão de criar um objeto de contexto, o qual será utilizado para definir a pipeline que será executada.

Para cada contexto haverá uma configuração de pipeline específica, composta por vários handlers.
Cada handler poderá fazer parte de várias pipelines, permitindo reutilização de código.

Os contextos poderão implementar interfaces específicas para determinados conjuntos de dados,
como, por exemplo, um interface que trata o parâmetro `scope`.
Dessa forma é possível criar handlers especializados para tratar de um conjunto específico de dados.

Os Handlers para formar a pipeline se distinguirão em três tipos:
- Validators: os quais apenas realizam uma validação sobre o contexto, podendo terminar a execução da Pipeline gerando respostas de falha.
- Decorators: os quais podem modificar o contexto, aplicar validações, continuar a execução da Pipeline, ou terminar a execução gerando alguma resposta.
- Handlers: o último handler da Pipeline, o qual gera a resposta final da requisição. Este handler é obrigatório e deverá receber um contexto já validado.

Completa os handlers os componentes:
- EndpointHandler: responsável por receber a requisição e criar um contexto.
- Context: objeto que armazenará os dados da requisição distinguindo cada operação.
- Pipeline: delega a execução para vários handlers de um contexto.
- Response: objeto que será utilizado para gerar a resposta da requisição, a qual será um `IResult` do AspNetCore.

Os serviços do IdentityServer4 serão mantidos, porém, poderão sofrer alterações, removidos, ou substituídos por novos serviços.

## 3. Consequências

Pretende-se que a reestruturação do IdentityServer4 torne o código mais modular, 
mais fácil de ser mantido, testado, evoluído e personalizado.

Entretanto, o objetivo final se dará aos poucos, porque será necessário um redesign e rescrita
massiva do código, o que pode levar tempo e esforço.

Sendo assim, boa parte do código do IdentityServer4 será simplesmente copiado para a nova estrutura,
e aos poucos será refatorado para atender a nova arquitetura e atingir os objetivos propostos.
